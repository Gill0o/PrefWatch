#!/bin/bash
set -euo pipefail

# Pre-commit hook for PrefWatch
# When prefwatch.sh is staged:
#   1. Remind to update CHANGELOG if not modified
#   2. Auto-stage CHANGELOG if modified but not staged
#   3. Update CHANGELOG date to today
#   4. On version bump: create release + CHANGELOG entry

ROOT_DIR=$(git rev-parse --show-toplevel)
cd "$ROOT_DIR"

SRC_REL="prefwatch.sh"
CHANGELOG_REL="CHANGELOG.md"

if git diff --name-only --cached | grep -qx "$SRC_REL"; then
  # Extract staged and HEAD versions
  STAGED_VERSION=$(git show ":$SRC_REL" | grep -m1 -E '^# Version:' | awk -F': ' '{print $2}' | tr -d '\r' || true)
  HEAD_VERSION=$(git show "HEAD:$SRC_REL" 2>/dev/null | grep -m1 -E '^# Version:' | awk -F': ' '{print $2}' | tr -d '\r' || true)
  DATE_STR=$(date +%Y-%m-%d)

  # --- Version bump: CHANGELOG entry + release ---
  if [ -n "$STAGED_VERSION" ] && [ "$STAGED_VERSION" != "$HEAD_VERSION" ]; then
    if [ -f "$CHANGELOG_REL" ]; then
      if ! grep -Eq "^##[[:space:]]*(v)?${STAGED_VERSION}(\\b|[[:space:]])" "$CHANGELOG_REL"; then
        tmpfile=$(mktemp)
        awk -v ver="$STAGED_VERSION" -v date="$DATE_STR" \
          'NR==1{print; print ""; print "## " ver " — " date; print ""; print "### Fix"; print "- ..."; print ""; next}1' \
          "$CHANGELOG_REL" > "$tmpfile"
        mv "$tmpfile" "$CHANGELOG_REL"
        echo "[pre-commit] CHANGELOG.md: new section for v$STAGED_VERSION"
      fi
    fi
    git add "$CHANGELOG_REL"

    echo "[pre-commit] Running release for v$STAGED_VERSION"
    "./release.sh" "$STAGED_VERSION"
    git add -A "release/" || true
  fi

  # --- Auto-stage CHANGELOG if modified (not staged) ---
  if git diff --name-only -- "$CHANGELOG_REL" 2>/dev/null | grep -qx "$CHANGELOG_REL"; then
    git add "$CHANGELOG_REL"
    echo "[pre-commit] CHANGELOG.md auto-staged"
  fi

  # --- Update CHANGELOG date to today ---
  CUR_VER="${STAGED_VERSION:-$HEAD_VERSION}"
  if [ -n "$CUR_VER" ] && [ -f "$CHANGELOG_REL" ] && \
     grep -Eq "^##[[:space:]]*(v)?${CUR_VER}[[:space:]]*—[[:space:]]*[0-9]{4}-[0-9]{2}-[0-9]{2}" "$CHANGELOG_REL"; then
    sed -i '' -E "s/^(##[[:space:]]*(v)?${CUR_VER}[[:space:]]*—[[:space:]]*)[0-9]{4}-[0-9]{2}-[0-9]{2}/\1${DATE_STR}/" "$CHANGELOG_REL"
    git add "$CHANGELOG_REL"
    echo "[pre-commit] CHANGELOG.md date → $DATE_STR"
  fi

  # --- Warn if CHANGELOG not touched ---
  if ! git diff --name-only --cached | grep -qx "$CHANGELOG_REL"; then
    echo ""
    echo "⚠  CHANGELOG.md not updated — pensez à documenter les changements"
    echo ""
  fi
fi

exit 0
